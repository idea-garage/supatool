# Supatool 詳細設計

## 1. ディレクトリ構成（例）
```
supatool/
  bin/            # CLIエントリポイント
  src/            # コアロジック
    parser/       # YAML/JSON/TS型パーサ
    generator/    # SQL/CRUD/型/RLS/ドキュメント生成
    templates/    # コードテンプレート
  docs/           # ドキュメント
  tests/          # ユニットテスト
```

## 2. 入力仕様
- YAML/JSON/TypeScript型でデータモデルを記述
- 例: model.yaml
```yaml
entities:
  - name: user_profiles
    description: ユーザープロファイル情報
    fields:
      - name: id
        type: uuid
        primary: true
      - name: name
        type: text
        notNull: true
    relations:
      - type: hasMany
        target: participants
```

## 3. コア機能
### 3.1 パース
- YAML/JSON/TS型をJSオブジェクトに変換

### 3.2 生成
- SQL: CREATE TABLE, 外部キー, RLSポリシー
- TypeScript型: DB型→TS型マッピング
- CRUD: supabase-js用の型付き関数
- ドキュメント/API仕様書: Markdown, OpenAPI等で自動生成

### 3.3 CLI
- コマンド例:
  - `supatool gen:sql model.yaml`
  - `supatool gen:crud model.yaml`
  - `supatool gen:types model.yaml`
  - `supatool gen:rls model.yaml`
  - `supatool gen:docs model.yaml`

## 4. 拡張性
- プラグイン方式で新しい生成器追加可能
- テンプレート差し替え対応

## 5. テスト
- Jest等でユニットテスト
- 入力→出力のスナップショットテスト

## 6. エラー処理
- 入力バリデーション
- 生成失敗時は詳細エラー出力

## 7. 今後の拡張案
- ER図自動生成
- UI自動生成
- DBマイグレーション生成

## 8. シードデータ取得機能（v0.3.5〜）

- 指定したテーブル（スキーマ指定可）のデータをリモートDBから取得し、AIコーディング用のシードデータとして保存
- 取得対象テーブルはYAMLで指定（例: tables.yaml）
- コマンド例:

```sh
supatool seed --tables tables.yaml
```

- 出力先: `supabase/seeds/{テーブル名}_seed.json`
- ファイル形式:

```json
{
  "table": "public.users",
  "fetched_at": "2024-06-07T12:34:56Z",
  "fetched_by": "supatool v0.3.5",
  "note": "This data is a snapshot of the remote DB at the above time. For AI coding reference. You can update it by running the update command again.",
  "rows": [ { ... }, ... ]
}
```

- これはリモートDBのスナップショット。AIはこのデータを元にコーディングし、必要に応じてupdateで最新化可能。

### tables.yaml 記載例

```yaml
# スキーマ指定なし（publicがデフォルト）
tables:
  - users
  - posts

# スキーマ指定あり
tables:
  - public.users
  - app_data.logs
```

#### llms.txt（AI seed data index）

- llms.txtは supabase/seeds/ 直下に毎回自動上書きで出力される
- サブフォルダ内には出力されない

- シード出力後、同じ日時付きフォルダ内にllms.txtが自動生成される
- そのフォルダ内の全_seed.jsonファイルをインデックス化
- 例：

```
# AI seed data index (generated by supatool)
# fetched_at: 2024-07-05T11:16:00Z
# folder: 20240705_1116_supatool
public.users: users_seed.json # ユーザーアカウントテーブル (2 rows)
public.orders: orders_seed.json (5 rows)
``` 